# EMBODIOS GRUB Configuration for UEFI Secure Boot
# This configuration enables signature verification for secure boot compliance

# Set timeout for menu selection (5 seconds)
set timeout=5

# Set default boot entry
set default=0

# Enable signature checking enforcement
# This ensures only signed kernels can boot when Secure Boot is enabled
set check_signatures=enforce

# Superusers can bypass signature checks if needed (for recovery)
set superusers="root"

# Set GRUB color scheme
set menu_color_normal=white/black
set menu_color_highlight=black/light-gray

# Main boot entry - Signed Kernel (Production)
menuentry 'EMBODIOS (Signed - Secure Boot)' {
    echo 'Loading signed EMBODIOS kernel...'
    echo 'Signature verification: ENABLED'

    # Set root device
    insmod part_msdos
    insmod part_gpt
    insmod ext2
    insmod iso9660

    # Load the signed kernel
    # The .signed suffix indicates this kernel has been signed with UEFI certificates
    if [ -f /boot/embodios.elf.signed ]; then
        multiboot2 /boot/embodios.elf.signed
        echo 'Booting with verified signature...'
        boot
    else
        echo 'ERROR: Signed kernel not found!'
        echo 'Please ensure embodios.elf.signed exists in /boot/'
        sleep 5
    fi
}

# Test/Development boot entry - Unsigned Kernel
# This option is useful for testing and development
# It will fail if Secure Boot is enabled in firmware
menuentry 'EMBODIOS (Unsigned - Development Only)' {
    echo 'Loading unsigned EMBODIOS kernel...'
    echo 'WARNING: Signature verification will fail if Secure Boot is enabled!'
    echo 'This option is for development and testing only.'

    # Set root device
    insmod part_msdos
    insmod part_gpt
    insmod ext2
    insmod iso9660

    # Load the unsigned kernel
    if [ -f /boot/embodios.elf ]; then
        multiboot2 /boot/embodios.elf
        boot
    else
        echo 'ERROR: Kernel not found!'
        sleep 5
    fi
}

# Recovery entry - Disable signature enforcement
# This requires superuser authentication
# Use only for recovery when signed kernel fails
menuentry 'EMBODIOS (Recovery - No Signature Check)' --users root {
    echo 'WARNING: Booting in recovery mode'
    echo 'Signature verification: DISABLED'

    # Temporarily disable signature checking for recovery
    set check_signatures=no

    # Set root device
    insmod part_msdos
    insmod part_gpt
    insmod ext2
    insmod iso9660

    # Try to boot any available kernel
    if [ -f /boot/embodios.elf.signed ]; then
        multiboot2 /boot/embodios.elf.signed
        boot
    elif [ -f /boot/embodios.elf ]; then
        multiboot2 /boot/embodios.elf
        boot
    else
        echo 'ERROR: No kernel found!'
        sleep 5
    fi
}

# UEFI Firmware Settings
# Allows access to UEFI setup to manage Secure Boot keys
if [ "${grub_platform}" == "efi" ]; then
    menuentry 'UEFI Firmware Settings' {
        fwsetup
    }
fi

# Reboot option
menuentry 'Reboot' {
    echo 'Rebooting system...'
    reboot
}

# Power off option
menuentry 'Power Off' {
    echo 'Shutting down...'
    halt
}
