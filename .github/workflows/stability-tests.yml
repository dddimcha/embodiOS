name: Stability Tests

on:
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual trigger
    inputs:
      duration:
        description: 'Test duration in seconds (3600=1h, 43200=12h, 259200=72h)'
        required: true
        default: '3600'
        type: choice
        options:
          - '60'      # 1 minute (smoke test)
          - '3600'    # 1 hour
          - '43200'   # 12 hours
          - '259200'  # 72 hours
      alert_webhook:
        description: 'Webhook URL for alerts (optional)'
        required: false
        type: string

env:
  PYTHONUNBUFFERED: "1"
  STABILITY_REPORT_DIR: "stability-reports"

jobs:
  stability-test:
    runs-on: ubuntu-latest
    timeout-minutes: 4400  # ~73 hours (allows for 72h test + overhead)

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
        pip install -e .

    - name: Determine test duration
      id: duration
      run: |
        # Use manual input if provided, otherwise default to 1 hour for nightly
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          DURATION="${{ github.event.inputs.duration }}"
        else
          DURATION="3600"  # 1 hour for scheduled nightly runs
        fi
        echo "duration=$DURATION" >> $GITHUB_OUTPUT
        echo "Running stability test for $DURATION seconds"

    - name: Create report directory
      run: |
        mkdir -p ${{ env.STABILITY_REPORT_DIR }}
        echo "Report directory created at ${{ env.STABILITY_REPORT_DIR }}"

    - name: Run stability test
      id: test
      run: |
        DURATION="${{ steps.duration.outputs.duration }}"
        REPORT_PATH="${{ env.STABILITY_REPORT_DIR }}/stability-report-$(date +%Y%m%d-%H%M%S).html"

        echo "Starting stability test (duration: ${DURATION}s)..."
        echo "Report will be saved to: $REPORT_PATH"

        # Run stability suite with checkpoint support
        python scripts/run_stability_suite.py \
          --duration "$DURATION" \
          --report "$REPORT_PATH" \
          --checkpoint-interval 300 \
          --deterministic

        TEST_EXIT_CODE=$?

        echo "exit_code=$TEST_EXIT_CODE" >> $GITHUB_OUTPUT
        echo "report_path=$REPORT_PATH" >> $GITHUB_OUTPUT

        if [ $TEST_EXIT_CODE -eq 0 ]; then
          echo "âœ… Stability test PASSED"
        else
          echo "âŒ Stability test FAILED (exit code: $TEST_EXIT_CODE)"
          exit $TEST_EXIT_CODE
        fi

    - name: Extract test metrics
      if: always()
      run: |
        # Look for stability metrics JSON files
        if ls tests/stability/*.json 1> /dev/null 2>&1; then
          echo "Test metrics found:"
          for file in tests/stability/*.json; do
            echo "  - $(basename $file)"
          done
        fi

        # Display summary if report exists
        if [ -f "${{ steps.test.outputs.report_path }}" ]; then
          echo "Stability report generated: ${{ steps.test.outputs.report_path }}"
          ls -lh "${{ steps.test.outputs.report_path }}"
        fi

    - name: Upload stability report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: stability-report-${{ steps.duration.outputs.duration }}s
        path: |
          ${{ env.STABILITY_REPORT_DIR }}/*.html
          tests/stability/*.json
          tests/stability/*.csv
        retention-days: 90

    - name: Upload checkpoint files (on failure)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: stability-checkpoints-failed
        path: |
          tests/stability/checkpoints/*.json
        retention-days: 30

    - name: Comment on PR (if applicable)
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const duration = '${{ steps.duration.outputs.duration }}';
          const exitCode = '${{ steps.test.outputs.exit_code }}';
          const status = exitCode === '0' ? 'âœ… PASSED' : 'âŒ FAILED';

          const comment = `## Stability Test Results ${status}

          **Duration:** ${duration}s (${Math.round(duration / 60)} minutes)
          **Exit Code:** ${exitCode}

          ${exitCode === '0'
            ? 'âœ… All stability metrics within acceptable thresholds'
            : 'âŒ Stability test failed - see artifacts for details'
          }

          ðŸ“Š [Download Stability Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          `;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

    - name: Post summary
      if: always()
      run: |
        DURATION="${{ steps.duration.outputs.duration }}"
        EXIT_CODE="${{ steps.test.outputs.exit_code }}"

        echo "## ðŸ”¬ Stability Test Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Duration:** ${DURATION}s ($(echo "scale=1; $DURATION / 60" | bc) minutes)" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** $([ "$EXIT_CODE" = "0" ] && echo "âœ… PASSED" || echo "âŒ FAILED")" >> $GITHUB_STEP_SUMMARY
        echo "**Exit Code:** $EXIT_CODE" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "$EXIT_CODE" = "0" ]; then
          echo "### âœ… Test Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All stability metrics remained within acceptable thresholds:" >> $GITHUB_STEP_SUMMARY
          echo "- Memory drift < 5%" >> $GITHUB_STEP_SUMMARY
          echo "- Latency degradation < 10% (P99)" >> $GITHUB_STEP_SUMMARY
          echo "- No critical alerts triggered" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âŒ Test Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Stability regression detected. Check the report for details." >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“Š Download the full stability report from the artifacts section." >> $GITHUB_STEP_SUMMARY

  weekly-long-test:
    runs-on: ubuntu-latest
    # Run weekly on Sundays at 3 AM UTC (only on schedule, not workflow_dispatch)
    if: github.event_name == 'schedule' && github.event.schedule == '0 3 * * 0'
    timeout-minutes: 4400  # ~73 hours

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
        pip install -e .

    - name: Run 12-hour stability test
      run: |
        mkdir -p ${{ env.STABILITY_REPORT_DIR }}
        REPORT_PATH="${{ env.STABILITY_REPORT_DIR }}/stability-report-12h-$(date +%Y%m%d-%H%M%S).html"

        echo "Starting 12-hour stability test..."
        python scripts/run_stability_suite.py \
          --duration 43200 \
          --report "$REPORT_PATH" \
          --checkpoint-interval 600 \
          --deterministic

    - name: Upload 12h report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: stability-report-12h
        path: |
          ${{ env.STABILITY_REPORT_DIR }}/*.html
          tests/stability/*.json
          tests/stability/*.csv
        retention-days: 180
